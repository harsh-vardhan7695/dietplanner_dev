<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clear Cache & Test Connection</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        button { background: #dc3545; color: white; padding: 15px 30px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px; }
        button:hover { background: #c82333; }
        .test-btn { background: #007bff; }
        .test-btn:hover { background: #0056b3; }
        .result { background: #f8f9fa; border: 1px solid #ddd; padding: 15px; margin-top: 20px; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        pre { white-space: pre-wrap; word-wrap: break-word; font-size: 12px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Cache Clear & Connection Test</h1>
        <p>Use this tool to clear all cached data and test the frontend-backend connection.</p>

        <div class="status" id="status">Ready to clear cache and test connection</div>

        <button onclick="clearAllCache()">üóëÔ∏è Clear All Cache & Storage</button>
        <button onclick="testConnection()" class="test-btn">üîó Test Backend Connection</button>

        <div id="result" class="result" style="display: none;">
            <h3>Results:</h3>
            <div id="resultContent"></div>
        </div>
    </div>

    <script>
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
        }

        function showResult(content, type = 'result') {
            const resultDiv = document.getElementById('result');
            const resultContent = document.getElementById('resultContent');
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'result ' + type;
            resultContent.innerHTML = content;
        }

        function clearAllCache() {
            updateStatus('Clearing all cache and storage...', 'info');
            
            try {
                // Clear localStorage
                localStorage.clear();
                
                // Clear sessionStorage
                sessionStorage.clear();
                
                // Clear all cookies
                document.cookie.split(";").forEach(function(c) { 
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                });

                // Clear IndexedDB (if any)
                if ('indexedDB' in window) {
                    indexedDB.databases().then(databases => {
                        databases.forEach(db => indexedDB.deleteDatabase(db.name));
                    });
                }

                updateStatus('‚úÖ All cache and storage cleared successfully!', 'success');
                
                showResult(`
                    <div class="success">
                        <h4>‚úÖ Cache Cleared Successfully!</h4>
                        <ul>
                            <li>localStorage: Cleared</li>
                            <li>sessionStorage: Cleared</li>
                            <li>Cookies: Cleared</li>
                            <li>IndexedDB: Cleared</li>
                        </ul>
                        <p><strong>Next Steps:</strong></p>
                        <ol>
                            <li>Test the backend connection below</li>
                            <li>Refresh your main application</li>
                            <li>Fill out the form again with fresh data</li>
                        </ol>
                    </div>
                `, 'success');

            } catch (error) {
                updateStatus('‚ùå Error clearing cache', 'error');
                showResult(`
                    <div class="error">
                        <h4>‚ùå Error Clearing Cache</h4>
                        <p>Error: ${error.message}</p>
                    </div>
                `, 'error');
            }
        }

        async function testConnection() {
            updateStatus('Testing backend connection...', 'info');
            
            try {
                // Test 1: Health check
                const healthResponse = await fetch('http://localhost:8000/api/health', {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });

                if (!healthResponse.ok) {
                    throw new Error(`Health check failed: ${healthResponse.status}`);
                }

                const healthData = await healthResponse.json();

                // Test 2: Simple API call
                const testData = {
                    user_id: `test-connection-${Date.now()}`,
                    goal: "weight-loss",
                    dietary_restrictions: "",
                    allergies: "test",
                    additional_notes: "Connection test",
                    user_info: {
                        age: "30",
                        gender: "Male",
                        height: "175",
                        weight: "75",
                        activity_level: "Moderate",
                        goals: "Weight Loss",
                        medical_conditions: "None",
                        medications: "None",
                        allergies: "test",
                        food_preferences: "No specific preferences",
                        cooking_ability: "Intermediate",
                        budget: "Medium",
                        cultural_factors: "None"
                    }
                };

                const apiResponse = await fetch('http://localhost:8000/api/generate-plan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    },
                    body: JSON.stringify(testData)
                });

                if (!apiResponse.ok) {
                    throw new Error(`API call failed: ${apiResponse.status}`);
                }

                const apiData = await apiResponse.json();

                updateStatus('‚úÖ Connection test successful!', 'success');
                
                showResult(`
                    <div class="success">
                        <h4>‚úÖ Backend Connection Successful!</h4>
                        
                        <h5>üè• Health Check:</h5>
                        <pre>${JSON.stringify(healthData, null, 2)}</pre>
                        
                        <h5>ü§ñ API Response (first 500 chars):</h5>
                        <pre>${(apiData.plan?.raw || apiData.plan || 'No plan content').substring(0, 500)}...</pre>
                        
                        <p><strong>‚úÖ Your backend is working perfectly!</strong></p>
                        <p>The issue is likely frontend caching. Try using your main app now.</p>
                    </div>
                `, 'success');

            } catch (error) {
                updateStatus('‚ùå Connection test failed', 'error');
                
                showResult(`
                    <div class="error">
                        <h4>‚ùå Backend Connection Failed</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                        
                        <h5>üîß Troubleshooting Steps:</h5>
                        <ol>
                            <li>Make sure your backend is running: <code>cd backend && python main.py</code></li>
                            <li>Check if port 8000 is accessible: <code>curl http://localhost:8000/api/health</code></li>
                            <li>Verify your API keys are set in backend/.env</li>
                            <li>Check for CORS issues in browser console</li>
                        </ol>
                    </div>
                `, 'error');
            }
        }

        // Auto-run connection test on page load
        window.addEventListener('load', () => {
            setTimeout(testConnection, 1000);
        });
    </script>
</body>
</html>
